# Plan: CLI isolation and index tests

## Overview
- Separate CLI tests from indexing logic now that [src/index.js](src/index.js) was split out.
- Keep CLI tests focused on argument parsing, help output, and error formatting while mocking index behavior.
- Add dedicated unit tests for index workflow and database transaction behavior.

## Steps
1. Audit current CLI coverage and identify assertions that exercise indexing logic.
2. Confirm existing integration tests to keep (high-quality ones) and document which CLI behaviors they cover.
3. Introduce dependency injection for `indexWorkflow` in [src/cli.js](src/cli.js) so tests can mock it without touching indexing internals.
4. Refactor CLI unit tests to use a mocked `indexWorkflow`, limiting coverage to:
   - command parsing and help output
   - input resolution (stdin vs file)
   - error handling and exit codes
   - success output formatting
5. Create new index workflow tests to cover `indexWorkflow` end-to-end with mocked collaborators (use Vitest for mocks as needed):
   - `ingest`, `chunkDocument`, `embedChunks`
   - `openDatabase`, `initSchema`, `persistIndexBatch`, `closeDatabase`, `getDatabaseStats`
   - verify debug logging and transaction behavior
6. Ensure no CLI unit test asserts on internal index debug logs or db stats; those move to index tests.
7. Run the test suite and adjust any fixtures or mocks needed for new coverage boundaries.

## Questions
1. Should we keep any integration-style CLI test that hits the real index workflow, or move all indexing behavior to index tests? **Answer: Maintain any tests explicitly described as integration if they are high quality.**
2. Is it acceptable to add a small mocking helper (hand-rolled) rather than a new dependency like `proxyquire`? **Answer: Vitest is now available.**
3. Preferred naming for index tests: [test/index.test.js](test/index.test.js) or [test/index.workflow.test.js](test/index.workflow.test.js)? **Answer: Follow existing convention.**
